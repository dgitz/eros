#DO NOT EDIT THIS FILE.  IT IS MAINTAINED THROUGH EROS.
#!/bin/bash
#Author: David Gitz
#Purpose: Syncs Software across all devices.

declare -a Devices=("ControlModule1" "ControlModule2" "dgitzrosmaster")
function print_usage()
{
    echo "Usage Instructions"
    echo "-a Sync to all Devices"
    echo "-r <device> Sync to remote device"
    echo "-l Sync to local Device"
    
}
function sync_config_local()  
{
    #Determine what the name of the ActiveScenario is:
    ActiveScenario=$(cat /home/robot/config/ActiveScenario)

    #Remove old launch files
    rm -r -f /home/robot/catkin_ws/src/icarus_rover_v2/launch/*

    #Copy contents of /home/robot/config/scenarios/<ActiveScenario>/* to /home/robot/catkin_ws/src/icarus_rover_v2/launch/
    cp /home/robot/config/scenarios/$ActiveScenario/launch/* /home/robot/catkin_ws/src/icarus_rover_v2/launch/
    
    #Sync CMakeLists.txt to the correct device
    source_file="/home/robot/config/scenarios/"$ActiveScenario"/CMakeLists/"$1".txt"
    cp $source_file /home/robot/catkin_ws/src/icarus_rover_v2/CMakeLists.txt

    #Sync package.xml to the correct device
    source_file="/home/robot/config/scenarios/"$ActiveScenario"/package/"$1".xml"
    cp $source_file /home/robot/catkin_ws/src/icarus_rover_v2/package.xml

    cp /home/robot/config/urdf/* /home/robot/catkin_ws/src/icarus_rover_v2/urdf/
}
function sync_to_all()
{
    for device in "${Devices[@]}"
    do
        if [ $device != $HOSTNAME ]; then
            echo "Syncing with Remote Device: "$device
          
	        sync_software_remote $device
        else 
            echo "Syncing with Local Device: "$device
            sync_config_local $device
        fi
    done
}

function sync_software_remote()
{
    #Sync config
    #Copy ActiveScenario name over.  This isn't used, just for information.
    rsync -ar /home/robot/config/ActiveScenario robot@$1:/home/robot/config
    
    #Determine what the name of the ActiveScenario is:
    ActiveScenario=$(cat /home/robot/config/ActiveScenario)
    
    #Remove old launch files
    ssh robot@$1 'rm -r -f /home/robot/catkin_ws/src/icarus_rover_v2/launch/*'
    #Copy contents of /home/robot/config/scenarios/<ActiveScenario>/* to /home/robot/catkin_ws/src/icarus_rover_v2/launch/
    rsync -avr /home/robot/config/scenarios/$ActiveScenario/launch/* robot@$1:/home/robot/catkin_ws/src/icarus_rover_v2/launch/
    rsync -ar /home/robot/config/DeviceFile.xml robot@$1:/home/robot/config/   
    rsync -ar /home/robot/config/TopicMap.xml robot@$1:/home/robot/config/
    rsync -ar /home/robot/config/targets/* robot@$1:/home/robot/config/targets/
    rsync -ar /home/robot/config/urdf/* robot@$1:/home/robot/config/urdf/
    rsync -avr /home/robot/scripts/* robot@$1:~/scripts

    #Sync CMakeLists.txt to the correct device
    source_file="/home/robot/config/scenarios/"$ActiveScenario"/CMakeLists/"$1".txt"
    echo "source:"$source_file
    rsync -ar $source_file robot@$1:/home/robot/catkin_ws/src/icarus_rover_v2/CMakeLists.txt

    #Sync package.xml to the correct device
    source_file="/home/robot/config/scenarios/"$ActiveScenario"/package/"$1".xml"
    echo "source:"$source_file
    rsync -ar $source_file robot@$1:/home/robot/catkin_ws/src/icarus_rover_v2/package.xml
    #Sync source code and make 

	rsync -avr /home/robot/catkin_ws/src/icarus_rover_v2/src/* robot@$1:/home/robot/catkin_ws/src/icarus_rover_v2/src/
    rsync -avr /home/robot/catkin_ws/src/icarus_rover_v2/util/* robot@$1:/home/robot/catkin_ws/src/icarus_rover_v2/util/
    rsync -avr /home/robot/catkin_ws/src/icarus_rover_v2/msg/* robot@$1:/home/robot/catkin_ws/src/icarus_rover_v2/msg/
    rsync -avr /home/robot/catkin_ws/src/icarus_rover_v2/include/* robot@$1:/home/robot/catkin_ws/src/icarus_rover_v2/include/
    #rsync -avr /home/robot/catkin_ws/devel/include/icarus_rover_v2/* robot@$1:/home/robot/catkin_ws/devel/include/icarus_rover_v2
    ssh robot@$1 "cd ~/catkin_ws && source devel/setup.bash && catkin_make"
}
if [ $# -eq 0 ]; then
    print_usage
fi
if [ "$1" = "-a" ]; then
    sync_to_all
elif [ "$1" = "-r" ]; then
    sync_software_remote $2
elif [ "$1" = "-l" ]; then
    sync_config_local $HOSTNAME
fi


